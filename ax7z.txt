----------------------------------------------------------------------------
                       ax7z.spi v0.7 for 7-zip 4.57+  y3b4
----------------------------------------------------------------------------
                                                    2013/08/25 Yak!

****************************************************************************
 本バージョンは beta 版です。まだ大きなバグが残っている可能性が高いです。
****************************************************************************

0.目次

  1.概要
  2.動作環境
  3.設定の説明
  4.パスワード付き書庫への対応
  5.動作確認
  6.コンパイル方法
  7.著作権・免責等
  8.既知の不具合・仕様
  9.連絡先
  10.TODO
  11.History

1.概要

  Makito Miyano 氏による 7-zip の解凍エンジンを利用した susieプラグインで
  ある、ax7z.spi v0.7 を 7-zip 4.57 向けにビルドしたものです。
  一部アプリケーションで相対パスつきアーカイブの処理に失敗する点と、取得できる
  場合には CRC 値も返すよう修正してあります。
  また、パスワード付き書庫も扱えるようにしています。

  7-zip が対応している形式全てを扱うことが可能です。
  7-zip 9.20 の DLL を使用している場合は、
    7z, XZ, BZIP2, GZIP, TAR, ZIP, WIM, ARJ, CAB, CHM, CPIO, CramFS, DEB,
    DMG, FAT, HFS, ISO, LZH, LZMA, MBR, MSI, NSIS, NTFS, RAR, RPM, SquashFS,
    UDF, VHD, WIM, XAR, Z
  等となります。
  なお、拡張子によって対応形式かどうかを判別し中身を見ていません。
  7-zip の DLL から取得できる情報以外に追加で拡張子を指定可能です。
  デフォルトで iso 用として bin, img, mdf を追加しています。
  ただし、これらのファイルが全て開けるわけではありません。

  現状 beta 版であり「6.既知の不具合・仕様」の通り色々と制限事項、機能不足が
  ありますのでご注意ください。

2.動作環境

  ax7z.spi 単独では動作しません。他に 7-zip 4.57 以降に含まれる 7z.dll が
  以下のいずれかの場所に必要です。
  ※ 7-zip 4.62, 4.65, 9.20, 9.22 の 7z.dll でも動作しているようです。

  ・ax7z.spi と同じフォルダ
  ・レジストリ HKCR\Software\7-zip\Path (文字列)に設定されたフォルダ
  ・レジストリ HKLM\Software\7-zip\Path (文字列)に設定されたフォルダ

  7-zip のインストーラによって上記レジストリ値が設定されるので、
  インストーラでインストールされた場合は、他に何もする必要はありません。

  63b3 までは spi ファイルと同じディレクトリに ax7z.ini を作成して
  いましたが、本バージョンからデフォルトでは以下のパスに ax7z.ini が
  作成されます。

  XP:         C:\Documents and Settings\<ユーザー名>\Application Data\ax7z
  Vista 以降: C:\Users\<ユーザー名>\AppData\Roaming\ax7z

  旧バージョンを使用していた場合、初回読み込み時に ini ファイルの
  場所を移動するか問い合わせます。「はい」で上記パスに移動、「いいえ」で
  従来のまま spi ファイルと同じディレクトリになります。
  設定によって、後から以前と同様 spi ファイルと同じディレクトリに ini を
  作成するよう変更することも可能です。

3.設定の説明

  通常の設定ダイアログもオリジナル版 ax7z.spi から変更しました。

  上側、DLL defined :となっているのが 7z.dll が対応している拡張子、形式の
  リストです。選択状態になっているものが有効です。
  Select all, Unselect all はそれぞれ全てを選択、非選択にします。
  Load default は全選択で、かつ、ユーザー定義拡張子(後述)を
  bin;img;mdf にします。

  下側 User-defined: がユーザー定義拡張子で、7z.dll で指定されている拡張子
  以外で ax7z.spi で扱いたい拡張子を指定します。
  ; 区切りで拡張子のみ(.不要)のリストで入力します。
  拡張子の順番は保存されません(次回設定時にはソートされています)。

  最下段の stay password dialog on top はパスワード入力用ダイアログを
  最前面にするかどうかの設定です。
  per-user configuration (ini in AppData) にチェックが入っている場合は、
  ini ファイルは「2.動作環境」のデフォルトのパスに、チェックを外した場合は、
  spi ファイルと同じディレクトリに作成されます。

4.パスワード付き書庫への対応

  パスワード付き書庫を開くとパスワード入力ダイアログが表示されます。
  基本的に入力されたパスワードはキャッシュされ、解凍エラーが発生した場合か、
  別の書庫を開いた場合、特定条件下でソリッド書庫を開いた場合に破棄されます。
  OK は通常のパスワード入力、Skip は解凍エラーを無視して次のファイルへ、
  Skip Archive は別の書庫まで解凍エラーを無視して処理を進めます。
  ファイル名が暗号化されている書庫の場合、Skip は選択できません。
  解凍エラー発生時の再入力の場合はダイアログのメッセージが Extract error,
  (以下略)のように表示が変わります。
  なお、異なるパスワードの書庫を開いた際に、解凍エラーと同じ表示になりますが、
  これはキャッシュされたパスワードで展開しようとしてエラーになるからです。

  ダイアログのタイトルバーで右クリック(あるいは Alt+スペース)で表示される
  メニューにある TopMost をチェックする、あるいはチェックを外すことにより
  ダイアログを最前面にするかどうかを切り替えることができます。
  デフォルト設定を切り替えたい場合は設定ダイアログで可能です。
  「3.設定の説明」を参照ください。

  パスワード周りについては実装も詰め切れておらず、また、そもそもどのような
  仕様にするべきか悩んでいる面もあり、提案、意見、要望等ありましたら掲示板
  にでもお願いいたします。

5.動作確認

  Windows7 Professional SP1 64bit + Core i7-2620M + NVS 4200M
  あふｗ v1.56 / Leeyes v2.6.1 / Hamana v1.48 / MassiGra v0.45 / Susie 0.47b

6.コンパイル方法

  以下の手順でコンパイルできます。
  なお外部ライブラリでバイナリ作成に使用したバージョンは 7-zip 4.57,
  Boost 1.54 です。

  1) 7-zip の本家サイト(http://www.7-zip.org/)より 7-zipのソースを
     取得します。
  2) Boost の本家サイト(http://www.boost.org/)よりソースを取得してビルド
     するか、バイナリインストーラを http://www.boostpro.com/products/free
     からダウンロードして実行、インストールします。
  3) Makito Miyano 氏のサイト(http://miyano.s53.xrea.com/)より ax7z.spi
     v0.7(ax7z20060619.zip)を取得します。
     ※ダウンロードできない場合は以下のミラーからダウンロードできます。
       http://yak3.myhome.cx:8080/junks/#misc.ax7z_spi
  4) ax7z20060619.zip 中の ax7z_src.zipを解凍します。
  5) 解凍すると 7zというフォルダができるので、そのフォルダに
     1) で取得した 7-zip のソース一式を解凍します。
  6) ax7z20060619-457y3b4.patch を適用します。
  7) 00am.slnを開き Boost のヘッダ検索パス、ライブラリ検索パスを調整して
     ビルドします。

  なお、UDF/ISO ブリッジへの暫定対応のため、7-zipのソースを一部改変
　しています(4.65 のソースからの back port 相当)。
  7-zipの関数を利用する部分は 7z/7zip/Bundles/ax7z 以下にあります。

7.著作権・免責等

  ファイルの圧縮、解凍の基本部分の著作権は Igor Pavlov 氏にあります。
  7z 圧縮方式の BZip2 アルゴリズムは Julian Seward 氏が作成し
  PPMD アルゴリズムは Dmitry Shkarin 氏が作成しています。
  susieプラグイン 作成部分に関しては Makito Miyano 氏が著作権を保有し
  ています。
  Boost ライブラリは Boost Software License で配布されています。

  ax7z.spi は GNU Lesser General Public License (LGPL)の元で配布されて
  います。ソフトの改変、再配布等については LGPL に従ってください。
  http://www.gnu.org/copyleft/lesser.ja.html

  また、本ソフトウェアを使用することによって如何なる損害が発生しても
  作者は一切責任を負わないものとします。
  全ては自己責任の元でお使いください。

8.既知の不具合・仕様

  ・Hamana でパスワード付き zip を開けない。
    (Hamana では zip の処理が内蔵ルーチン優先のため。
     Susie プラグイン側では対応不可能)
  ・展開途中に別の書庫を開くとパスワード入力ダイアログが連続して複数回開く
    場合がある。
  ・Hamana でパスワード付きソリッド書庫を開くと常にパスワード入力ダイアログが
    表示される(エラーが発生しても同一ファイルに対してパスワード再入力が
    できないので、必ず入力を行わせるため)
  ・エラーチェックが甘すぎる。
  ・ファイル単体が 2GB を超えると正常動作しない。
    (Susie plugin 仕様自体の制限)

9.連絡先

  不具合、要望、感想等は Yak! <yak_ex@mx.scn.tv> までお願いします。
  本パッチ版について Makito Miyano 氏に質問したりしないようお願いします。

10.TODO

  ・7-zip 9.2x への移行

11.History

  2013/08/25 (y3b4)
    - マルチユーザー環境向けにデフォルトの ini 作成位置を変更
    - 使用 7z.dll のバージョンをバージョン情報に表示
    - バージョンリソースを設定
    - SPI 関数で例外を補足するよう変更
    - 開発環境を VisualStudio 2012 に変更
    - Boost を 1.54 に更新

  2009/06/16 (y3b3)
    - パスワード入力用ダイアログを最前面にする設定を追加

  2009/10/21 (y3b2)
    - gzip, bzip2 系の書庫(.tar.gz, .tgz 等)が展開できなかった点を修正
    - ファイル名が暗号化された書庫に対応
    - パスワードの取り扱いを変更(4.参照)

  2009/08/23 (y3b1)
    - パスワードのキャッシュに対応(解凍対象書庫変更まで有効)

  2009/08/11 (y3b0)
    - ソリッド書庫展開高速化版を分離
    - Hamana 用ソリッド書庫展開時のパスワード入力に対応

  2009/02/22 (y2b5)
    - パスワードに対応
    - 7-zip の DLL が対応している形式全てに対応できるように変更
    - SQLite を 3.6.11 に更新

  2009/02/12 (y2b4)
    - UDF/ISO ブリッジに暫定的に対応(7-zip 4.65 の DLL が必要)

  2009/02/12 (y2b3)
    - SQLite を 3.6.10 に更新
    - iso に対応

  2009/01/01 (y2b2)
    - SQLite を 3.6.7 に更新
    - 書庫ファイルの更新時刻かサイズが変化した場合、ファイルキャッシュを削除
    - スレッド間排他制御追加
    - (Susie plugin 仕様範囲内で) 2GB の壁を排除
    - キャッシュ済みマーク、チェック、削除のバグを修正

  2008/12/14 (y2b1)
    - 書庫タイプ(rar, 7-zip)による汎用ソリッド書庫展開高速化の有効・
      無効設定を追加
    - メモリキャッシュ、ディスクキャッシュの併用、サイズ制限を追加

  2008/11/16 (y2b0)
    - 汎用ソリッド書庫展開高速化の concept proof 版を実装

  2008/03/02 (y1)
    - 取得できる場合は CRC 値を返すよう修正

  2008/01/16 (初版)
    - ax7z.spi v0.7 を 7-zip ver4.57 用にビルド
